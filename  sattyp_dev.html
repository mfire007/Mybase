<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ANINOTE PLATINUM</title>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.294.0/dist/umd/lucide.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --p-bg: #000000;
            --p-accent: #ffffff;
            --p-panel: rgba(15, 15, 18, 0.85);
            --p-card: rgba(255, 255, 255, 0.05);
            --p-blur: 25px;
            --p-border: rgba(255, 255, 255, 0.1);
            --c-blue: #007AFF; --c-yellow: #FFD60A; --c-green: #32D74B;
        }

        /* --- ЛОУДЕРА --- */
        #loader-wrapper {
            position: fixed; inset: 0; z-index: 999999;
            background-color: #000; background-size: cover; background-position: center;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.8s cubic-bezier(0.65, 0, 0.35, 1);
        }
        .loader-content { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .loader-logo { position: relative; width: 80px; height: 80px; display: flex; justify-content: center; align-items: center; color: #fff; }
        .loader-ring { 
            position: absolute; inset: 0; border: 2px solid rgba(255,255,255,0.05); 
            border-top: 2px solid var(--p-accent); border-radius: 50%; 
            animation: loader-spin 1s cubic-bezier(0.4, 0, 0.2, 1) infinite; 
        }
        .loader-title { font-weight: 800; letter-spacing: 5px; font-size: 1rem; color: #fff; }
        .loader-finish { opacity: 0 !important; filter: blur(30px); transform: scale(1.1); pointer-events: none; }
        @keyframes loader-spin { to { transform: rotate(360deg); } }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif !important; -webkit-tap-highlight-color: transparent; }
        body { background: var(--p-bg); color: #fff; height: 100vh; overflow: hidden; position: relative; }

        #bg-layer { position: fixed; inset: 0; background-size: cover; background-position: center; z-index: -2; transition: 0.8s ease; }
        .bg-dim { position: fixed; inset: 0; background: rgba(0,0,0,0.45); backdrop-filter: blur(var(--p-blur)); -webkit-backdrop-filter: blur(var(--p-blur)); z-index: -1; }

        .app-header { position: fixed; top: 0; width: 100%; z-index: 100; background: var(--p-panel); border-bottom: 0.5px solid var(--p-border); padding-top: env(safe-area-inset-top); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); }
        .h-wrap { max-width: 600px; margin: 0 auto; padding: 14px 20px; display: flex; justify-content: space-between; align-items: center; }
        .logo-box { display: flex; align-items: center; gap: 10px; }
        .logo-box b { font-weight: 800; letter-spacing: 3px; font-size: 0.9rem; text-transform: uppercase; }
        
        .h-actions { display: flex; gap: 12px; }
        .btn-icon { width: 40px; height: 40px; border-radius: 14px; border: 1px solid var(--p-border); background: rgba(255,255,255,0.05); color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .btn-add { background: var(--p-accent); color: #000; border: none; width: 40px; height: 40px; border-radius: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        .filters { display: flex; gap: 8px; max-width: 600px; margin: 0 auto; padding: 10px 20px 15px; }
        .f-item { flex: 1; padding: 12px; border-radius: 14px; font-size: 0.65rem; font-weight: 800; text-align: center; background: rgba(255,255,255,0.04); color: rgba(255,255,255,0.3); transition: 0.3s; border: 1px solid transparent; cursor: pointer; }
        .f-item.active { color: #fff; border-color: var(--p-border); }
        .f-item.active[data-f="watching"] { background: var(--c-blue); box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3); }
        .f-item.active[data-f="waiting"] { background: var(--c-yellow); color: #000; box-shadow: 0 4px 15px rgba(255, 214, 10, 0.3); }
        .f-item.active[data-f="watched"] { background: var(--c-green); color: #000; box-shadow: 0 4px 15px rgba(50, 215, 75, 0.3); }

        .scroll-view { height: 100vh; overflow-y: auto; padding: 160px 20px 100px; }
        .list-grid { max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 14px; }
        .card { background: var(--p-card); border: 1px solid var(--p-border); border-radius: 24px; display: flex; align-items: center; gap: 16px; position: relative; overflow: hidden; backdrop-filter: blur(10px); transition: 0.2s; min-height: 80px; }
        
        .card.locked { opacity: 0.5; filter: grayscale(0.5); }
        .card.locked .card-info, .card.locked .btn-sm:not(.btn-lock) { pointer-events: none; }

        .status-indicator { width: 6px; height: 50px; border-radius: 0 4px 4px 0; flex-shrink: 0; }
        .watching .status-indicator { background: var(--c-blue); }
        .waiting .status-indicator { background: var(--c-yellow); }
        .watched .status-indicator { background: var(--c-green); }

        .card-info { flex: 1; padding: 18px 0; cursor: pointer; min-width: 0; }
        .card-info h3 { 
            font-size: 0.9rem; font-weight: 700; margin-bottom: 4px; line-height: 1.3;
            word-wrap: break-word; overflow-wrap: break-word; display: -webkit-box;
            -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
        }
        .card-info p { font-size: 0.7rem; font-weight: 800; opacity: 0.5; text-transform: uppercase; letter-spacing: 0.5px; }

        .card-btns { display: flex; gap: 8px; padding-right: 18px; align-items: center; }
        .btn-sm { width: 36px; height: 36px; border-radius: 50%; border: 1px solid var(--p-border); background: rgba(255,255,255,0.04); color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        .btn-sm.main { background: var(--p-accent); color: #000; border: none; }
        .btn-lock { transition: 0.3s; color: rgba(255,255,255,0.2); }
        .card.locked .btn-lock { color: var(--c-green); }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(10px); opacity: 0; transition: 0.3s; }
        .overlay.show { display: flex; opacity: 1; }
        .sheet { width: 100%; max-width: 550px; background: var(--p-panel); border-radius: 35px 35px 0 0; padding: 15px 25px 40px; border-top: 1px solid var(--p-border); transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .overlay.show .sheet { transform: translateY(0); }
        .drag-bar { width: 45px; height: 5px; background: rgba(255,255,255,0.15); border-radius: 10px; margin: 0 auto 25px; }

        .setting-block { margin-bottom: 24px; }
        .setting-block label { display: block; font-size: 0.65rem; font-weight: 800; opacity: 0.5; text-transform: uppercase; margin-bottom: 12px; letter-spacing: 1px; }
        .color-row { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .color-dot { width: 42px; height: 42px; border-radius: 50%; border: 3px solid transparent; flex-shrink: 0; cursor: pointer; transition: 0.2s; }
        .color-dot.active { border-color: #fff; transform: scale(1.1); }
        .input-box { width: 100%; background: rgba(255,255,255,0.06); border: 1px solid var(--p-border); border-radius: 18px; padding: 18px; color: #fff; font-size: 0.9rem; font-weight: 600; outline: none; margin-bottom: 15px; }
        .step-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .step-card { background: rgba(255,255,255,0.04); border-radius: 22px; padding: 12px; border: 1px solid var(--p-border); display: flex; justify-content: space-between; align-items: center; }
        .btn-action { width: 100%; background: #fff; color: #000; padding: 18px; border-radius: 18px; border: none; font-weight: 800; font-size: 0.9rem; cursor: pointer; margin-top: 10px; }

        .info-card { background: rgba(255,255,255,0.03); border: 1px solid var(--p-border); border-radius: 20px; padding: 20px; margin-bottom: 15px; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.85rem; }
        .info-row span:first-child { opacity: 0.5; font-weight: 600; }
        .info-row span:last-child { font-weight: 800; color: var(--p-accent); }
        .badge-stable { background: var(--c-green); color: #000; padding: 2px 8px; border-radius: 6px; font-size: 10px; text-transform: uppercase; }

        input[type="range"] { -webkit-appearance: none; width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 5px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #fff; border-radius: 50%; cursor: pointer; }
    </style>
</head>
<body>

<div id="loader-wrapper">
    <div class="loader-content">
        <div class="loader-logo"><div class="loader-ring"></div><i data-lucide="pen" size="32"></i></div>
        <div class="loader-title">ANINOTE 12</div>
    </div>
</div>

<div id="bg-layer"></div>
<div class="bg-dim"></div>

<header class="app-header">
    <div class="h-wrap">
        <div class="logo-box"><i data-lucide="pen" size="22" fill="currentColor"></i><b>ANINOTE 12</b></div>
        <div class="h-actions">
            <button class="btn-icon" onclick="openUI('info')"><i data-lucide="info" size="20"></i></button>
            <button class="btn-icon" onclick="openUI('studio')"><i data-lucide="palette" size="20"></i></button>
            <button class="btn-add" onclick="openUI('add')"><i data-lucide="plus" size="24"></i></button>
        </div>
    </div>
    <div class="filters">
        <div class="f-item active" data-f="watching" onclick="setFilter('watching')">СМОТРЮ</div>
        <div class="f-item" data-f="waiting" onclick="setFilter('waiting')">ОЖИДАНИЕ</div>
        <div class="f-item" data-f="watched" onclick="setFilter('watched')">ПРОСМОТРЕНО</div>
    </div>
</header>

<main class="scroll-view"><div class="list-grid" id="main-list"></div></main>

<div class="overlay" id="ui-overlay" onclick="if(event.target.id==='ui-overlay')closeUI()">
    <div class="sheet" id="ui-sheet"></div>
</div>

<input type="file" id="bg-picker" hidden accept="image/*">

<script>
    // --- ПРОВЕРКА АВТОПЕРЕЗАГРУЗКИ ---
    (function initLoader() {
        const sessionKey = 'aninote_reload_v12';
        const loader = document.getElementById('loader-wrapper');
        const savedBg = localStorage.getItem('at_bg_v6');
        if(savedBg) loader.style.backgroundImage = `url(${savedBg})`;

        // Если в этой сессии еще не было перезагрузки — перезагружаем один раз
        if (!sessionStorage.getItem(sessionKey)) {
            sessionStorage.setItem(sessionKey, 'done');
            location.reload(); 
            return;
        }

        window.addEventListener('load', () => {
            if(window.lucide) lucide.createIcons();
            setTimeout(() => {
                loader.classList.add('loader-finish');
                setTimeout(() => loader.style.display = 'none', 800);
            }, 1000);
        });
    })();

    let db = JSON.parse(localStorage.getItem('at_db_v6')) || [];
    let config = JSON.parse(localStorage.getItem('at_cfg_v6')) || { accent: '#ffffff', panel: 'rgba(15, 15, 18, 0.85)', blur: 25 };
    let filter = 'watching', editId = null, sVal = 1, eVal = 1, stVal = 'watching';

    function sync() {
        const r = document.documentElement.style;
        r.setProperty('--p-accent', config.accent);
        r.setProperty('--p-panel', config.panel);
        r.setProperty('--p-blur', config.blur + 'px');
        const bg = localStorage.getItem('at_bg_v6');
        if(bg) document.getElementById('bg-layer').style.backgroundImage = `url(${bg})`;
        localStorage.setItem('at_cfg_v6', JSON.stringify(config));
    }

    function openUI(mode, id = null) {
        const sheet = document.getElementById('ui-sheet');
        sheet.style.transform = 'translateY(0)';

        if(mode === 'studio') {
            sheet.innerHTML = `
                <div class="drag-bar"></div>
                <div class="setting-block"><label>Цвет акцента</label><div class="color-row" id="accent-row">
                    ${['#ffffff','#007AFF','#FFD60A','#FF453A','#32D74B','#AF52DE','#FF9F0A'].map(c => 
                        `<div class="color-dot ${config.accent===c?'active':''}" style="background:${c}" onclick="setCfg('accent','${c}', this)"></div>`
                    ).join('')}
                </div></div>
                <div class="setting-block"><label>Стиль панелей</label><div class="color-row" id="panel-row">
                    ${['rgba(15,15,18,0.85)','rgba(40,40,45,0.9)','rgba(0,10,30,0.9)','rgba(30,0,0,0.8)','rgba(30, 90, 90, 0.8)'].map(c => 
                        `<div class="color-dot ${config.panel===c?'active':''}" style="background:${c}" onclick="setCfg('panel','${c}', this)"></div>`
                    ).join('')}
                </div></div>
                <div class="setting-block"><label id="blur-label">Размытие фона: ${config.blur}px</label>
                <input type="range" min="0" max="50" value="${config.blur}" oninput="setCfg('blur',this.value)"></div>
                <button class="input-box" onclick="document.getElementById('bg-picker').click()">СМЕНИТЬ ОБОИ</button>
                <button class="btn-action" onclick="closeUI()">ОКЕЙ</button>`;
        } else if (mode === 'info') {
            sheet.innerHTML = `
                <div class="drag-bar"></div>
                <div style="text-align:center; margin-bottom:25px">
                    <div style="font-size: 1.5rem; font-weight: 800; letter-spacing: 4px; margin-bottom:5px; color: var(--p-accent)">ANINOTE</div>
                    <div style="opacity: 0.5; font-size: 0.7rem; font-weight: 800">PLATINUM EXPERIENCE</div>
                </div>
                <div class="info-card">
                    <div class="info-row"><span>Версия</span><span>12.0.0</span></div>
                    <div class="info-row"><span>Статус</span><span class="badge-stable">Стабильная</span></span></div>
                    <div class="info-row"><span>Разработчик</span><span>MFIRE 777 ANINOTE</span></div>
<div class="info-row"><span>Обновление</span><span>Скоро</span></div>
                </div>
                <button class="btn-action" onclick="closeUI()" style="margin-top:10px">ЗАКРЫТЬ</button>`;
        } else {
            editId = id; const i = id ? db.find(x => x.id == id) : null;
            sVal = i ? i.s : 1; eVal = i ? i.e : 1; stVal = i ? i.status : filter;
            sheet.innerHTML = `
                <div class="drag-bar"></div>
                <input type="text" id="f-name" class="input-box" placeholder="Название..." value="${i?i.name:''}">
                <div class="step-container">
                    <div class="step-card">
                        <button class="btn-sm" onclick="vUpdate('s',-1)"><i data-lucide="minus" size="16"></i></button>
                        <div style="text-align:center"><b id="v-s">${sVal}</b><br><span style="font-size:10px;opacity:0.5">СЕЗОН</span></div>
                        <button class="btn-sm" onclick="vUpdate('s',1)"><i data-lucide="plus" size="16"></i></button>
                    </div>
                    <div class="step-card">
                        <button class="btn-sm" onclick="vUpdate('e',-1)"><i data-lucide="minus" size="16"></i></button>
                        <div style="text-align:center"><b id="v-e">${eVal}</b><br><span style="font-size:10px;opacity:0.5">СЕРИЯ</span></div>
                        <button class="btn-sm" onclick="vUpdate('e',1)"><i data-lucide="plus" size="16"></i></button>
                    </div>
                </div>
                <input type="number" id="f-limit" class="input-box" placeholder="Лимит серий (опционально)" value="${i?.limit || ''}">
                <div class="filters" style="padding:0; margin-bottom:20px">
                    <div class="f-item ${stVal==='watching'?'active':''}" onclick="stChange('watching',this)">СМОТРЮ</div>
                    <div class="f-item ${stVal==='waiting'?'active':''}" onclick="stChange('waiting',this)">ОЖИДАНИЕ</div>
                    <div class="f-item ${stVal==='watched'?'active':''}" onclick="stChange('watched',this)">ПРОСМОТРЕНО</div>
                </div>
                <button class="btn-action" onclick="save()">СОХРАНИТЬ</button>
                ${editId ? `<button onclick="del()" style="width:100%;background:none;border:none;color:#FF453A;font-weight:800;margin-top:20px;font-size:12px">УДАЛИТЬ</button>` : ''}`;
        }
        document.getElementById('ui-overlay').style.display = 'flex';
        setTimeout(() => {
            document.getElementById('ui-overlay').classList.add('show');
            lucide.createIcons();
            bindSwipe();
        }, 10);
    }

    function setCfg(k, v, el) { 
        config[k] = v; sync(); 
        if(k === 'blur') {
            document.getElementById('blur-label').innerText = `Размытие фона: ${v}px`;
        } else if(el) {
            // Визуальное переключение активной точки без перерендера всей шторки
            el.parentElement.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
        }
    }

    function closeUI() {
        document.getElementById('ui-overlay').classList.remove('show');
        setTimeout(() => { document.getElementById('ui-overlay').style.display='none'; }, 400);
    }

    function render() {
        const box = document.getElementById('main-list');
        box.innerHTML = '';
        db.filter(x => x.status === filter).reverse().forEach(i => {
            const isWatching = i.status === 'watching', isLocked = isWatching && i.locked;
            const el = document.createElement('div');
            el.className = `card ${i.status} ${isLocked ? 'locked' : ''}`;
            el.innerHTML = `
                <div class="status-indicator"></div>
                <div class="card-info" onclick="${isLocked ? '' : `openUI('edit', ${i.id})`}">
                    <h3>${i.name}</h3>
                    <p>Сезон ${i.s} • Серия ${i.e}${i.limit ? ' / '+i.limit : ''}</p>
                </div>
                <div class="card-btns">
                    ${isWatching ? `<button class="btn-sm btn-lock" onclick="toggleLock(${i.id}, event)"><i data-lucide="${isLocked?'check-circle-2':'circle'}" size="18"></i></button>` : ''}
                    <button class="btn-sm" onclick="quick(${i.id},-1,event)"><i data-lucide="minus" size="18"></i></button>
                    <button class="btn-sm main" onclick="quick(${i.id},1,event)"><i data-lucide="plus" size="18"></i></button>
                </div>`;
            box.appendChild(el);
        });
        lucide.createIcons();
    }

    function toggleLock(id, e) { e.stopPropagation(); db = db.map(i => { if(i.id == id) i.locked = !i.locked; return i; }); saveData(); render(); }
    function quick(id, v, e) {
        if(e) e.stopPropagation();
        db = db.map(i => {
            if(i.id == id && !i.locked) {
                i.e = Math.max(1, i.e+v);
                if(i.limit && i.e >= i.limit) { i.e = i.limit; i.status = 'watched'; i.locked = false; }
            }
            return i;
        });
        saveData(); render();
    }

    function save() {
        const name = document.getElementById('f-name').value.trim().toUpperCase();
        if(!name) return;
        const entry = { id: editId || Date.now(), name, s: sVal, e: eVal, limit: document.getElementById('f-limit').value, status: stVal, locked: editId ? (db.find(x=>x.id==editId)?.locked || false) : false };
        if(editId) db = db.map(x => x.id == editId ? entry : x); else db.push(entry);
        saveData(); render(); closeUI();
    }

    function saveData() { localStorage.setItem('at_db_v6', JSON.stringify(db)); }
    function stChange(s, el) { stVal = s; document.querySelectorAll('.sheet .f-item').forEach(x => x.classList.remove('active')); el.classList.add('active'); }
    function setFilter(f) { filter = f; document.querySelectorAll('.app-header .f-item').forEach(x => x.classList.toggle('active', x.dataset.f===f)); render(); }
    function vUpdate(t, v) { if(t==='s') sVal = Math.max(1, sVal+v); else eVal = Math.max(1, eVal+v); document.getElementById('v-s').innerText = sVal; document.getElementById('v-e').innerText = eVal; }
    function del() { db = db.filter(x => x.id != editId); saveData(); render(); closeUI(); }

    function bindSwipe() {
        const s = document.getElementById('ui-sheet');
        let startY = 0;
        s.ontouchstart = e => { startY = e.touches[0].clientY; s.style.transition = 'none'; };
        s.ontouchmove = e => {
            let d = e.touches[0].clientY - startY;
            if(d > 0) s.style.transform = `translateY(${d}px)`;
        };
        s.ontouchend = e => {
            s.style.transition = 'transform 0.4s cubic-bezier(0.16, 1, 0.3, 1)';
            if(e.changedTouches[0].clientY - startY > 150) closeUI();
            else s.style.transform = 'translateY(0)';
        };
    }

    document.getElementById('bg-picker').onchange = e => {
        const r = new FileReader();
        r.onload = () => { localStorage.setItem('at_bg_v6', r.result); sync(); };
        r.readAsDataURL(e.target.files[0]);
    };

    sync(); render();
</script>
</body>
</html>